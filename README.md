# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

# Архитектура

Архитектурный паттерн: Model-View-Presenter.
Код приложения разделён на:

- слой данных, отвечает за хранение и изменение данных;
- слой отображения, отвечает за отображение данных на странице;
- презентер, отвечает за связь между отображением и слоем данных.

## Типы данных, используемые в приложении

Модель карточек:

```
interface ICardsData {
	items: ICard[];
	getItem(cardId: string): ICard;
	getItems(): ICard[];
}
```

Карточка товара:

```
interface ICard {
	id: string;
	description: string;
	image: string;
	title: string;
	category: string;
	price: number;
}
```

Корзина:

```
interface IBasket extends ICardsData {
	counter: number;
	addItem(cardId: string): number;
	removeItem(cardId: string): void;
	getTotalPrice(): number;
}
```

Данные покупателя:

```
interface IUserData {
	payment: string;
	email: string;
	phone: string;
	address: string;
	clear(): void;
	getUserData(): IUserData;
}
```

Данные заказа:

```
interface IOrder extends IUserData {
	total: number;
	items: string[]; // массив с идентификаторами товаров
}
```

Отображение карточки:

```
interface ICardView {
	id: string;
	cardTemplate: HTMLTemplateElement;
	element: HTMLElement;
	description: HTMLElement;
	image: HTMLImageElement;
	title: HTMLElement;
	category: HTMLElement;
	price: HTMLElement;
	render(): HTMLElement;
}
```

Главная страницы:

```
interface IPage {
	container: HTMLElement;
	basketCounter: HTMLElement;
	render(items: ICard[]): void;
	showBasketAmount(items: number): void
}
```

Модальное окно:

```
interface IModal {
	template: HTMLTemplateElement;
	closeButton: HTMLButtonElement;
	submitButton: HTMLButtonElement;
	content: HTMLElement;
	open(): void;
	close(): void;
}
```

### Базовый код

#### Класс API

Содержит базовую логику отправки запросов. В конструктор передаётся адрес сервера и опционально — объект с заголовками запроса.

Методы:

- `get` — выполнит GET-запрос на переданный в параметрах эндпоинт и вернёт Promise с ответом сервера;
- `post` — принимает объект с данными, которые будут переданы в формате JSON в теле запроса, и отправляет эти данные на эндпоинт — второй параметр метода. Метод POST-запроса может быть переопределён путём задания третьего параметра, по-умолчанию выполняется POST.

#### Класс EventEmitter

Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий. Основные методы, реализуемые классом описаны интерфейсом. Класс имеет следующие методы:

- `on` — устанавливает обработчик на событие;
- `off` — снимает обработчик с события;
- `emit` — воспроизводит событие;
- `trigger` — возвращает функцию, которая при вызове инициализирует событие, переданное в параметрах метода. Таким образом, помимо обработчиков события может содержать дополнительную обработку.
- `onAll` — вызвать все события;
- `offAll` — удалить все события.

### Слой данных

#### Класс CardsData

Класс необходим для работы с массивом карточек. Конструктор класса принимает экземпляр класса EventEmitter и массив карточек.\

Поля:

- `items: ICard[]` — массив карточек;
- `events: IEvents` — экземпляр класса `EventEmitter` для инициализации событий при изменении данных;

Методы:

- `getItem(cardId: string): ICard` — возвращает отдельно взятую карточку;
- `getItems(): ICard[]` — возвращает массив карточек;

#### Класс UserData

Класс необходим для работы с данными пользователя.\
Конструктор класса принимает инстант брокера событий.\

Поля:

- `payment: string` — метод оплаты;
- `email: string` — эл.почта пользователя;
- `phone: string` — номер телефона пользователя;
- `address: string` — адрес пользователя;
- `events: IEvents` — экземпляр класса `EventEmitter` для инициализации событий при изменении данных;

Методы: геттеры и сеттеры для сохранения/получения данных пользователя, а также:

- `clear(): void` — очистит данные пользователя;
- `getUserData(): IUserData` — вернёт объект с данными пользователя;

#### Класс Basket

Расширяет класс CardsData, реализуя методы добавления товара, подсчёта количества и общей стоиомости всех товаров в корзине.\
Конструктор класса принимает инстант брокера событий.\

Методы:

- `addItem(cardId: string): number` — добавит в корзину товар и вернёт общее количество товаров;
- `removeItem(cardId: string): void` — удалит товар из корзины и вызовет событие изменения корзины;
- `getTotalPrice(): number` — вернёт сумму всех товаров в корзине;
- `get counter(): number` — вернёт количество товаров в корзине;

### Слой отображения

Отвечают за отображение и взаимодействие с пользователем.

#### Класс Card

Предназначен для работы с отображением карточки и её взаимодействием с пользователем.
Конструктор принимает объект карточки, шаблон карточки и экземпляр брокера событий.

Поля:

- `_id: string` — идентификатор товара;
- `cardTemplate: HTMLTemplateElement` — шаблон карточки;
- `element: HTMLElement` — элемент карточки;
- `description: HTMLElement` — описание товара;
- `image: HTMLImageElement` — изображение товара;
- `title: HTMLElement` — название товара;
- `category: HTMLElement` — категория товара;
- `price: HTMLElement` — цена товара;
- `events: IEvents` — экземпляр брокера событий;

Методы:

- `render(): HTMLElement` — метод возвращает готовый элемент карточки с установленным на неё слушателем клика;
- `get id(): string` — возвращает \_id карточки;

#### Класс Page

Предназначен для работы с контейнером карточек на главной странице.
Конструктор принимает экземпляр брокера событий, контейнер для карточек и контейнер кнопки корзины.

Поля:

- `container: HTMLElement` - контейнер с карточками;
- `basketCounter: HTMLElement` - элемент, отображающий количество добавленных в корзину товаров;

Методы:

- `render(items: ICard[]): void` - выведет карточки в контейнер;
- `showBasketAmount(items: number): void` — отобразит в иконке корзины количество добавленных товаров;

#### Класс Modal

Необходим для реализации модального окна.\
Содержит методы для открытия и закрытия модального окна (вставки в него контента), устанавливает слушатели на клавишу ESC (закрытие мод.окна при нажатии), на оверлей и кнопку-крестик (закрытие при клике).\

Конструктор класса:
`constructor(container: HTMLElement, templateId: string, events: IEvents)`, где:

- `container: HTMLElement` — контейнер, в котором размещаются модальные окна;
- `id:string` — айди шаблона, который должен быть найден в разметке;
- `events: IEvents` — экземпляр брокера событий;

Поля:

- `template: HTMLTemplateElement` — шаблон модального окна;
- `closeButton: HTMLButtonElement` — кнопка закрытия;
- `submitButton: HTMLButtonElement` — кнопка подтверждения действия;
- `content: HTMLElement` - контейнер с контентом модального окна;
- `events: IEvents` — экземпляр класса `EventEmitter` для инициализации событий при изменении данных;

Методы:

- `open(): void` - открывает модальное окно, вставляя контент-контейнер;
- `close(): void` — закрывает модального окно, очищая контент-контейнер;

#### Класс ModalWithForm

Наследует класс `Modal`. Предназначен для реализации модального окна с формой. При сабмите инициирует событие, в которое передаёт объект с данными из полей ввода. При изменении данных в поле ввода также инициирует событие изменения данных. Предоставляет методы для отображения ошибок и управляет активностью кнопки подтверждения.
Конструктор принимает инстант брокера событий.

Поля:

- `submitButton: HTMLButtonElement` — кнопка подтверждения;
- `form: HTMLFormElement` — элемент формы;
- `formName: string` — название формы;
- `inputs: HTMLCollection<HTMLInputElement>` — коллекция всех полей ввода формы;
- `errors: Record<string, HTMLElement>` — объект, хранящий элементы ошибок, привязаных к инпутам, где `string` — имя инпута, `HTMLElement` — элемент ошибки;

Методы:

- `toggleButtonState(formValid: boolean): void` — включает/отключает кнопку подтверждения;
- `setError(data: {fieldName: string, fieldValue: string, errorMessage: string}): void` — добавляет ошибку в поле errors;
- `showInputError(fieldName: string, errorMessage: string): void` — отображает текст ошибки;
- `hideInputError(fieldName: string)` — скрывает текст ошибки под указанным полем ввода;
- `close(): void` — расширяет родительский метод, при закрытии модального окна дополнительно очищая поля ввода и деактивируя кнопку сохранения;
- `get form(): HTMLFormElement` — геттер для получения элемента формы;

#### Класс ModalWithItem

Расширяет класс Modal. Предназначен для реализации модального окна товара. При открытии модального окна получает объект карточки, по которой кликнули.

Поля класса представляют следующие данные:

- `image: HTMLImageElement` — элемент разметки, отображающий изображение товара;
- `category: HTMLElement` — элемент разметки категории товара;
- `name: HTMLElement` — элемент разметки имени товара;
- `description: HTMLElement` — элемент разметки описания товара;
- `cost: HTMLElement` — элемент разметки цены товара;

Методы:

- `open(item: ICard): void` — расширяет родительский метод, принимая объект карточки, который используется для заполнения модального окна;
- `close(): void` — расширяет родительский метод, выполняя дополнительно очистку модального окна при закрытии;
- `toggleButtonState(cardId): void` — отключает/включает кнопку, если товар уже был добавлен в корзину;

#### Класс ModalWithBasket

Расширяет класс Modal. Предназначен для реализации модального окна корзины.

Поля:

- `itemsList: HTMLElement` — контейнер списка товаров;
- `itemsCost: HTMLElement` — элемент разметки, отображающий общую стоимость товаров;

Методы:

- `render(items: ICard[]): void` — заполняет корзину добавленными в неё товарами, отобразив общую стоимость;

### Слой коммуникации

#### Класс AppAPI

Класс предоставляет методы взаимодействия с бэкендом. Конструктор принимает инстант класса API.

## Слой презентера

Роль презентера будет выполнять код, распологающийся в файле `./src/index.ts`. Он описывает взаимодействие отображения и данных.\
Сначала создаются все необходимые экземпляры классов, а затем настраивается работа событий.\
События, генерируемые брокером событий вызывают обработчики, за счёт которых и осуществляется взаимодействие.\

### Список событий

#### События изменения данных

_Создаются классами моделей._

- `basket:changed` - изменение количества товаров корзины;
- `userData:changed` - изменение данных пользователя;
- `item:selected` - добавление товара в корзину;

#### События взаимодействия с интерфейсом

_Создаются классами отображения._

- `modal:close` - закрытие модального окна;
- `basket:open` - открытие корзины;
- `basket:removeItem` - удаление товара из корзины;
- `basket:submit` - нажатие кнопки «оформить» в корзине;
- `item:open` - нажатие на карточку;
- `item:select` - нажатие на кнопку «в корзину» в модальном окне карточки;
- `payment-method: changed` - выбор метода оплаты;
- `address: changed` - изменение данных в поле с адресом;
- `modal-address:submit` - нажатие на кнопку «далее» в модальном окне с адресом доставки;
- `email:changed` - изменение данных в поле с почтой;
- `phone-number:changed` - изменение данных в поле с номером телефона;
- `modal-contacts:submit` - нажатие на кнопку «далее» в модальном окне с почтой и телефоном;

### Пример взаимодействия

_Взаимодействия классов на примере добавления товара в корзину:_

1. Слой отображения. В классе ModalWithItem навешивается слушатель события клика по кнопке «Добавить в корзину».
2. Слой презентера. Клик вызывает обработчик события «item:selected» из слоя презентера. В обработчике события вызывается метод модели Basket.addItem(cardId).
3. Слой данных. Модель записывает новые данные, после чего происходит событие «basket:changed».
4. Слой презентера. В обработчике «basket:changed» вызывается функция слоя отображения ModalWithBasket.render(items).
5. Слой отображения. Метод render() отобразит карточки из массива Basket.items.
